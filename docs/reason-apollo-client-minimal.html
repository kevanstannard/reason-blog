<!doctype html><html data-reactroot=""><head><title>Minimal ReasonML and GraphQL Apollo Client</title><meta charSet="utf-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet"/><link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/default.min.css" rel="stylesheet"/><link href="static/styles.css" rel="stylesheet"/></head><body><div class="p-10"><p class="mb-4"><a class="hover:underline" href="index.html">‚Üê Back to index</a></p><h1 class="text-5xl font-black mb-4">Minimal ReasonML and GraphQL Apollo Client</h1><p class="mb-12">Sat Dec 28 2019</p><div class="blogPostBody"><h2>Prerequisites</h2>
<p>You will need a working GraphQL server.</p>
<p>For this example we will use a public <a href="http://apis.guru/graphql-apis/">Star Wars GraphQL API</a>.</p>
<p>Or, you may like to browse other <a href="http://apis.guru/graphql-apis/">public GraphQL APIs</a>.</p>
<h2>Versions used in this example</h2>
<table>
<thead>
<tr>
<th>Package</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>bs-platform</td>
<td>7.0.1</td>
</tr>
<tr>
<td>reason-apollo</td>
<td>0.18.0</td>
</tr>
<tr>
<td>@baransu/graphql_ppx_re</td>
<td>0.4.6</td>
</tr>
<tr>
<td>graphql</td>
<td>14.5.8</td>
</tr>
</tbody>
</table>
<h2>Install BuckleScript globally</h2>
<pre><code>yarn global add bs-platform
</code></pre>
<h2>Create the project</h2>
<pre><code class="language-bash">bsb -init reason-apollo-simple -theme react-starter
<span class="hljs-built_in">cd</span> ./reason-apollo-simple
yarn
</code></pre>
<h2>Test the project is working</h2>
<pre><code class="language-bash">yarn build
yarn server
</code></pre>
<p>Then browse to <a href="http://localhost:8000/">http://localhost:8000/</a></p>
<h2>Install Apollo GraphQL dependencies</h2>
<pre><code class="language-bash">yarn add reason-apollo
yarn add --dev @baransu/graphql_ppx_re
</code></pre>
<h2>Update bsconfig.json</h2>
<p>Add <code>reason-apollo</code> to the <code>bs-dependencies</code> and add <code>ppx-flags</code> for <code>graphql_ppx_re</code>:</p>
<pre><code class="language-json">&quot;bs-dependencies&quot;: [
  &quot;reason-react&quot;,
  &quot;reason-apollo&quot;
],
&quot;ppx-flags&quot;: [&quot;@baransu/graphql_ppx_re/ppx6&quot;],
</code></pre>
<h2>Write code for sending an introspection query</h2>
<p>I couldn't figure out a nice way to do this.</p>
<p>This is a slightly modified version of <a href="https://github.com/mhallin/graphql_ppx/blob/master/sendIntrospectionQuery.js">sendIntrospectionQuery.js</a> from the <a href="https://github.com/mhallin/graphql_ppx">graphql_ppx</a> package.</p>
<p>Install dependencies.</p>
<pre><code class="language-bash">yarn add --dev yargs
yarn add --dev request
</code></pre>
<p>Create a new file <code>./tools/send-introspection-query.js</code>.</p>
<p>Add the content:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> argv = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;yargs&quot;</span>).argv;
<span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;request&quot;</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>);
<span class="hljs-keyword">const</span> { getIntrospectionQuery } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;graphql&quot;</span>);

<span class="hljs-keyword">const</span> requestOptions = {
  <span class="hljs-attr">json</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">body</span>: { <span class="hljs-attr">query</span>: getIntrospectionQuery() },
  <span class="hljs-attr">headers</span>: { <span class="hljs-string">&quot;user-agent&quot;</span>: <span class="hljs-string">&quot;node.js&quot;</span>, ...argv.headers }
};

request.post(argv._[<span class="hljs-number">0</span>], requestOptions, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, response, body</span>) </span>{
  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&quot;Could not send introspection query: &quot;</span>, error);
    process.exit(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">if</span> (response.statusCode !== <span class="hljs-number">200</span>) {
    <span class="hljs-built_in">console</span>.error(
      <span class="hljs-string">&quot;Non-ok status code from API: &quot;</span>,
      response.statusCode,
      response.statusMessage
    );
    process.exit(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">var</span> result = <span class="hljs-built_in">JSON</span>.stringify(body, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>);

  fs.writeFileSync(<span class="hljs-string">&quot;graphql_schema.json&quot;</span>, result, { <span class="hljs-attr">encoding</span>: <span class="hljs-string">&quot;utf-8&quot;</span> });
});
</code></pre>
<p>Then add a new script to your <code>package.json</code> file:</p>
<pre><code>&quot;send-introspection-query&quot;: &quot;node ./tools/send-introspection-query&quot;
</code></pre>
<h2>Run the introspection query</h2>
<pre><code class="language-bash">yarn send-introspection-query https://swapi-graphql.netlify.com/.netlify/<span class="hljs-built_in">functions</span>/index
</code></pre>
<p>If successful, this will generate a <code>graphql_schema.json</code> file in the root of your project.</p>
<h2>Create the Apollo Client</h2>
<p>Now we can start following the instructions on the <a href="https://github.com/apollographql/reason-apollo">reason-apollo</a> site.</p>
<p>Create the file <code>src/Client.re</code></p>
<pre><code class="language-reasonml"><span class="hljs-comment">/* Create an InMemoryCache */</span>
<span class="hljs-keyword">let</span> inMemoryCache = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ApolloInMemoryCache</span>.</span></span>create<span class="hljs-constructor">InMemoryCache()</span>;

<span class="hljs-comment">/* Create an HTTP Link */</span>
<span class="hljs-keyword">let</span> httpLink =
  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ApolloLinks</span>.</span></span>create<span class="hljs-constructor">HttpLink(~<span class="hljs-params">uri</span>=<span class="hljs-string">&quot;https://swapi-graphql.netlify.com/.netlify/functions/index&quot;</span>, ()</span>);

<span class="hljs-keyword">let</span> instance =
  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ReasonApollo</span>.</span></span>create<span class="hljs-constructor">ApolloClient(~<span class="hljs-params">link</span>=<span class="hljs-params">httpLink</span>, ~<span class="hljs-params">cache</span>=<span class="hljs-params">inMemoryCache</span>, ()</span>);
</code></pre>
<h2>Add the provider</h2>
<p>Change the render code in <code>src/Index.re</code> from this:</p>
<pre><code class="language-reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ReactDOMRe</span>.</span></span>render<span class="hljs-constructor">ToElementWithId(&lt;App <span class="hljs-operator">/</span>&gt;, <span class="hljs-string">&quot;root&quot;</span>)</span>;
</code></pre>
<p>to this:</p>
<pre><code class="language-reasonml">ReactDOMRe.renderToElementWithId(
  &lt;ReasonApollo.Provider client=Client.instance&gt;
    &lt;App /&gt;
  &lt;/ReasonApollo.Provider&gt;,
  &quot;root&quot;,
);
</code></pre>
<h2>Add the query</h2>
<p>Next add a file <code>src/Movies.re</code> and add the GraphQL query:</p>
<pre><code class="language-reasonml"><span class="hljs-keyword">module</span> GetMovies = <span class="hljs-literal">[%<span class="hljs-identifier">graphql</span>
  {|
    <span class="hljs-identifier">query</span> {
      <span class="hljs-identifier">allFilms</span> {
        <span class="hljs-identifier">films</span> {
          <span class="hljs-identifier">id</span>
          <span class="hljs-identifier">title</span>
        }
      }
    }
  |}
]</span>;

<span class="hljs-keyword">module</span> GetMoviesQuery = ReasonApollo.<span class="hljs-constructor">CreateQuery(GetMovies)</span>;
</code></pre>
<h2>Add a type</h2>
<p>Let's also add a type for the film titles we will be displaying:</p>
<pre><code class="language-reasonml"><span class="hljs-keyword">type</span> film = {
  id: <span class="hljs-built_in">string</span>,
  title: <span class="hljs-built_in">string</span>,
};
</code></pre>
<h2>Handle the API response</h2>
<p>Next add a function for handling the API response.
The response <code>option</code> values, so parsing it is a bit involved:</p>
<pre><code class="language-reasonml">let responseToFilms = response =&gt;
  response##allFilms
  -&gt;Belt.Option.flatMap(allFilms =&gt; allFilms##films)
  -&gt;Belt.Option.mapWithDefault([||], film =&gt; film)
  |&gt; Array.fold_left(
       (acc, filmOpt) =&gt; {
         switch (filmOpt) {
         | Some(film) =&gt;
           let id = film##id;
           let titleOpt = film##title;
           switch (titleOpt) {
           | Some(title) =&gt; Array.append(acc, [|{id, title}|])
           | None =&gt; acc
           };
         | None =&gt; acc
         }
       },
       [||],
     );
</code></pre>
<h2>Add the component</h2>
<p>Lastly, now we can add the component to the same file:</p>
<pre><code class="language-reasonml"><span class="hljs-literal">[@<span class="hljs-identifier">react</span>.<span class="hljs-identifier">component</span>]</span>
<span class="hljs-keyword">let</span> make =<span class="hljs-function"> <span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">let</span> getMoviesQuery = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">GetMovies</span>.</span></span>make<span class="hljs-literal">()</span>;
  &lt;GetMoviesQuery variables=getMoviesQuery##variables&gt;
    ...{({result}) =&gt;
      switch (result) {
      <span class="hljs-pattern-match">| <span class="hljs-constructor">Loading</span> =&gt;</span> &lt;div&gt; {<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">React</span>.</span></span><span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;Loading&quot;</span>)} &lt;/div&gt;
      <span class="hljs-pattern-match">| <span class="hljs-constructor">Error(<span class="hljs-params">error</span>)</span> =&gt;</span> &lt;div&gt; {<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">React</span>.</span></span><span class="hljs-built_in">string</span>(error##message)} &lt;/div&gt;
      <span class="hljs-pattern-match">| <span class="hljs-constructor">Data(<span class="hljs-params">response</span>)</span> =&gt;</span>
        <span class="hljs-keyword">let</span> films = response<span class="hljs-constructor">ToFilms(<span class="hljs-params">response</span>)</span>;
        &lt;ul&gt;
          {films<span class="hljs-operator">
           |&gt; </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Array</span>.</span></span>map(film =&gt;
                &lt;li key={film.id}&gt; {<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">React</span>.</span></span><span class="hljs-built_in">string</span>(film.title)} &lt;/li&gt;
              )<span class="hljs-operator">
           |&gt; </span><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">React</span>.</span></span><span class="hljs-built_in">array</span>}
        &lt;/ul&gt;;
      }
    }
  &lt;/GetMoviesQuery&gt;;
};
</code></pre>
<h2>Updating the App component</h2>
<p>Lastly, let's update the <code>App</code> component in <code>src/App.re</code>. Replace the file with the following content:</p>
<pre><code class="language-reasonml"><span class="hljs-literal">[@<span class="hljs-identifier">react</span>.<span class="hljs-identifier">component</span>]</span>
<span class="hljs-keyword">let</span> make =<span class="hljs-function"> <span class="hljs-params">()</span> =&gt;</span> {
  &lt;Movies /&gt;;
};
</code></pre>
</div></div></body></html>