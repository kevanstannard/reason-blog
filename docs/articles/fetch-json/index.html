<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>How to fetch JSON data with ReasonML? - Hello
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="ReasonML and Bucklescript">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>How to fetch JSON data with ReasonML?</h1>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><h2 id="install-dependencies">Install dependencies</h2>
<p>You will need to install two<span class="widont">&nbsp;</span>dependencies:</p>
<ul>
<li><a href="https://github.com/reasonml-community/bs-fetch">bs-fetch</a> provides a wrapper around your browser’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch<span class="widont">&nbsp;</span><span class="caps">API</span></a>.</li>
<li><a href="https://github.com/glennsl/bs-json">bs-json</a> provides <span class="caps">JSON</span> decoding<span class="widont">&nbsp;</span>functions.</li>
</ul>
<h2 id="preparing-your-data-source">Preparing your data<span class="widont">&nbsp;</span>source</h2>
<p>You may already have an <span class="caps">API</span> available, but if you are just experimenting you may like to use an <span class="caps">API</span> from public-apis.
We’ll be using one of the public APIs that provides random pictures of<span class="widont">&nbsp;</span>cats.</p>
<pre><code>https://aws.random.cat/meow</code></pre><p>This has a <span class="caps">JSON</span> response that looks<span class="widont">&nbsp;</span>like:</p>
<pre><code>{
  file: &quot;https://purr.objects-us-east-1.dream.io/i/w8V75.jpg&quot;
}</code></pre><h2 id="fetching-the-data">Fetching the data</h2>
<p>We can do a simple <span class="caps">JSON</span> fetch using the<span class="widont">&nbsp;</span>following:</p>
<pre><code class="language-reasonml"><span class="module-access"><span class="module"><span class="identifier">Js</span>.</span><span class="module"><span class="identifier">Promise</span>.</span>(
  Fetch.fetch("https://aws.random.cat/meow")
  <span class="operator">|&gt;</span> then_(Fetch.Response.json)
  <span class="operator">|&gt;</span> then_(json =&gt; Js.log(json) <span class="operator">|&gt;</span> resolve)</span>
);</code></pre>
<p>Next, let’s convert this to a function that returns the cat<span class="widont">&nbsp;</span>data.</p>
<h2 id="declaring-your-api-response-type">Declaring your <span class="caps">API</span> response<span class="widont">&nbsp;</span>type</h2>
<p>In this case the response type is very<span class="widont">&nbsp;</span>simple:</p>
<pre><code class="language-reasonml"><span class="keyword">type</span> catData = {file: <span class="built_in">string</span>};</code></pre>
<h2 id="converting-your-api-response">Converting your <span class="caps">API</span><span class="widont">&nbsp;</span>response</h2>
<p>Let’s declare a Decode module with a catData function that converts the generic <code>Js.Json.t</code> type into a proper <code>catData</code> type.</p>
<pre><code class="language-reasonml"><span class="keyword">module</span> Decode = {
  <span class="keyword">let</span> catData =<span class="function"> (<span class="params">data</span>: J<span class="params">s</span>.J<span class="params">son</span>.<span class="params">t</span>) =&gt;</span>
    <span class="module-access"><span class="module"><span class="identifier">Json</span>.</span><span class="module"><span class="identifier">Decode</span>.</span>{file: field(<span class="string">"file"</span>, <span class="built_in">string</span>, data)}</span>;
};</code></pre>
<p>Next we’ll create a fetchCat function to perform the fetch and convert the<span class="widont">&nbsp;</span>response.</p>
<pre><code class="language-reasonml"><span class="keyword">let</span> fetchCat =<span class="function"> <span class="params">()</span> =&gt;</span>
  <span class="module-access"><span class="module"><span class="identifier">Js</span>.</span><span class="module"><span class="identifier">Promise</span>.</span>(
    Fetch.fetch("https://aws.random.cat/meow")
    <span class="operator">|&gt;</span> then_(Fetch.Response.json)
    <span class="operator">|&gt;</span> then_(obj =&gt; obj |&gt; Decode.catData |&gt; resolve)
  )</span>;

<span class="module-access"><span class="module"><span class="identifier">Js</span>.</span><span class="module"><span class="identifier">Promise</span>.</span>(
  fetchCat()
  <span class="operator">|&gt;</span> then_(data =&gt; data.file |&gt; Js.log |&gt; resolve)
)</span>;</code></pre>
<h2 id="making-the-fetch-function-more-generic">Making the fetch function more<span class="widont">&nbsp;</span>generic</h2>
<p>Next let’s convert the fetch function into something more<span class="widont">&nbsp;</span>re-usable.</p>
<p>For this we can abstract out the url and the<span class="widont">&nbsp;</span>decoder.</p>
<pre><code class="language-reasonml"><span class="keyword">let</span> fetchJson =<span class="function"> (<span class="params">url</span>, <span class="params">decoder</span>) =&gt;</span>
  <span class="module-access"><span class="module"><span class="identifier">Js</span>.</span><span class="module"><span class="identifier">Promise</span>.</span>(
    Fetch.fetch(url)
    <span class="operator">|&gt;</span> then_(Fetch.Response.json)
    <span class="operator">|&gt;</span> then_(obj =&gt; obj |&gt; decoder |&gt; resolve)
  )</span>;

<span class="keyword">let</span> fetchCat =<span class="function"> <span class="params">()</span> =&gt;</span>
  fetch<span class="constructor">Json(<span class="string">"https://aws.random.cat/meow"</span>, Decode.<span class="params">catData</span>)</span>;

<span class="module-access"><span class="module"><span class="identifier">Js</span>.</span><span class="module"><span class="identifier">Promise</span>.</span>(
  fetchCat()
  <span class="operator">|&gt;</span> then_(data =&gt; data.file |&gt; Js.log |&gt; resolve)
)</span>;</code></pre>
<h2 id="converting-from-a-promise-to-an-option">Converting from a promise to an<span class="widont">&nbsp;</span>option</h2>
<p>You may like to work with <code>option</code> values <code>Some</code> or <code>None</code> rather than<span class="widont">&nbsp;</span>promises.</p>
<p>Let’s convert the above code to use a callback that provides an <code>option</code> value.</p>
<pre><code class="language-reasonml">let fetchJsonWithCallback = (url, decoder, callback) =&gt;
  Js.Promise.(
    fetchJson(url, decoder)
    |&gt; then_(result =&gt; callback(Some(result)) |&gt; resolve)
    |&gt; catch(_err =&gt; callback(None) |&gt; resolve)
    |&gt; ignore
  );

let fetchCatWithCallback = callback =&gt;
  fetchJsonWithCallback(
    "https://aws.random.cat/meow",
    Decode.catData,
    callback,
  );

fetchCatWithCallback(result =&gt;
  switch (result) {
  | None =&gt; Js.log("Fetch failed")
  | Some(catData) =&gt; Js.log(catData.file)
  }
);</code></pre>
<h2 id="references">References</h2>
<p>Fetching Data in ReasonML Pt. 1<br><a href="https://medium.com/@sharifsbeat/fetching-data-in-reasonml-pt-1-c06f3cc6b250">https://medium.com/@sharifsbeat/fetching-data-in-reasonml-pt-1-c06f3cc6b250</a></p>
<p>ReasonML Promise<br><a href="https://reasonml.github.io/docs/en/promise">https://reasonml.github.io/docs/en/promise</a></p>
<p>ReasonReact Hacker News<br><a href="https://github.com/reasonml-community/reason-react-hacker-news">https://github.com/reasonml-community/reason-react-hacker-news</a></p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <div class="nav"><a href="/">&laquo; Full blog</a></div>
        <section class="copy">
          <p>&copy; 2019 Kevan Stannard &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a></p>
        </section>
      </div>
    </footer>
  </body>
</html>